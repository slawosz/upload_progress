<!DOCTYPE html>
<html>
  <head>
    <title>Super Upload</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script language="javascript" type="text/javascript">
      var progressUpdater;
      var formActionUrl = '/upload?uid='
      var currentUid;

      function submitForm(form) {
        setUid();
        form.action = formActionUrl + currentUid;
        form.submit();
        enableDescriptionEditing();
        traceProgress(currentUid);
      }

      function traceProgress() {
        displayPercent(0);
        checkProgress(currentUid);
        progressUpdater = setInterval( 
          function() {
            checkProgress(currentUid);
          },
          1000
        )
      }

      function checkProgress() {
        xhr = new XMLHttpRequest();
        xhr.open('GET','/progress?uid=' + currentUid, true);
        xhr.onreadystatechange = function() {
          if (xhr.readyState == 4) {
            displayPercent(xhr.responseText);
          }
        }
        xhr.send()
      }

      function displayPercent(value) {
        document.getElementById('progress').innerHTML = 'Status: ' + value + '%';
      }

      function setUid() {
        currentUid = new Date().getTime();
        return currentUid;
      }

      function enableDescriptionEditing() {
        document.getElementById('submit-description').disabled = false;
      }

      function submitDescription(form) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/description?uid=' + currentUid, true);
        formData = new FormData(form);
        xhr.onreadystatechange = function() {
          if (xhr.readyState == 4) {
            eval(xhr.responseText);
          }
        }
        xhr.send(formData);
        return false;
      }
    </script>
  </head>
  <body>
    <form target='uploader' enctype="multipart/form-data" method="post">
      <input type="file" name="files" onChange="submitForm(this.form)"><BR>
    </form>
    <div id="link"></div>
    <div id="progress">
      Select file to start upload.
    </div>
    <div id="description">
    </div>
    <form method="post" onSubmit="return submitDescription(this)">
      <textarea id='description' name='description'></textarea>
      <input type="submit" id="submit-description" disabled="true"/>
    </form>
    <iframe name='uploader' style='display: none'/>
  </body>
</html>
